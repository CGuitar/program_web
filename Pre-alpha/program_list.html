<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务条摆放/添加-测试网页</title>
</head>
<style>
/*
用于测试任务拖动的任务网页，测试正常，达到预期目的可以进行下一步的预估
与任务计划
2024/10/29
*/
section.option{
    position: absolute;
    right: 0px;
    top: 0px;
    height: 30%;
    width: 20%;
    opacity: 80%;
    transition: 2ms;
    border-radius: 10px;
    border: 2px solid rgb(179, 195, 174);
    background-color: rgb(159, 80, 27);
}

/*生成按钮*/
section #create{
    width: 20%;
    height: 20%;
    position: absolute;
    left: 0px;
    margin: 20px;
}

section.option #tell{
    position: absolute;
    right: -2px;
    top: 90px;
    margin: 15px;
}

/*展示窗口*/
section#show_window{
    position: absolute;
    top: 0px;
    bottom: 0px;
    left: 0px;
    right: 0px;
    
    /*添加竖线*/
    background: linear-gradient(to right, #d5d8f1 2px, transparent 2px);
    background-size: 10% 100%;
    
}

/*任务条*/
section #program{
    z-index: 2;
    transition: 100ms;
    position: absolute;
    background-color: rgb(147, 225, 38);
    width: 9%;
    height: 8%;
    margin: 8px;
    right: 20px;
    top: 20px;
    border-radius: 10px;
}

/*样本任务条*/
section #program_sample{
    z-index: 2;
    transition: 300ms;
    position: absolute;
    background-color: rgb(47, 48, 45);
    width: 9%;
    height: 8%;
    margin: 8px;
    left: 20px;
    top: 20px;
    border-radius: 10px;
}

#program_sample #list{
    
    opacity: 0%;/*目标值80%*/
    position: absolute;
    border-radius: 10px;
    top: 50px;
    left: 30px;
    width: 300px;
    height: 300px;
    background-color: rgb(164, 165, 182);
    transition: 1000ms;
}

</style>
<body>
<section id="show_window">
    <div id="program_sample">
        <div id="list"></div>
    </div>
</section>
<section class="option">
    <h1 id="show">sample</h1>
    <button id = "create">create</button>
    <h1 id="tell">⬆拖动任务条⬆</h1>
</section>
</body>

<script>
//创建任务对象
const program = document.getElementById("program");
const borad = document.getElementById("show_window");
const show = document.getElementById("show");
const buttonCreate = document.getElementById("create");
const program_sample = document.getElementById("program_sample");
const detail = document.getElementById("list");

addEventListener("contextmenu",(e) =>{
    e.preventDefault();
    const target = e.target.closest(".DraggableContainer");
    const target_menu = document.getElementById("uniqueId");
    if(e.target.classList.contains('draggable-container')){
        if(e.button == 2){
            new Menu_list("show_window",e.pageX,e.pageY);
        }
    }

})


//测试
document.addEventListener("mousedown",function(event){
    const mune_list = document.getElementById("mune1");
    if(!(event.target == mune_list)){
        mune_list.remove();
    }
})

//菜单类
class Menu_list{
    constructor(containerID,pageX,pageY){
        this.continer = document.getElementById(containerID);

        //设定菜单栏尺寸
        var width = 200 ,height = 260;

        this.menu = document.createElement("div");
        this.menu.style.zIndex = "2";
        this.menu.style.borderRadius = "10px";
        this.menu.id = "mune1";
        this.menu.style.width = width + 'px';
        this.menu.style.height = height + 'px';
        this.menu.style.backgroundColor = "rgb(47, 48, 45)";
        this.menu.style.position = "absolute";
        //this.menu.style.transition = "200ms";
        
        //环境信息
        this.width = this.continer.offsetWidth;
        this.height = this.continer.offsetHeight;

        //菜单信息
        this.element_W = width;
        this.element_H = height;
        
        //位置信息
        this.pageX = pageX;
        this.pageY = pageY;

        this.addElement_judge(this.menu);
    }

    //生成函数
    addElement_judge(element){
        
        //宽度差值 （从左到右
        var width_diff =  this.width - this.pageX;

        //高度差值 （自上而下
        var height_diff = this.height - this.pageY;

        //判断是否越界
        if(width_diff < this.element_W){this.pageX =  this.width - this.element_W - 20;}
        if(height_diff < this.element_H){this.pageY =  this.height - this.element_H - 20;}
        element.style.top = this.pageY + 'px';
        element.style.left = this.pageX + 'px';
        
        this.continer.appendChild(element);
    }


}

//创建任务条的类
class DraggableContainer{
    constructor(containerID){
        this.continer = document.getElementById(containerID);

        var width = 9 ,height = 8;
        this.element1 = document.createElement("div");
        this.element1.className = "draggable-container";
        this.element1.id = "uniqueId"; // 赋予id属性
        this.element1.style.zIndex = "2";
        this.element1.style.transition = "300ms";
        this.element1.style.position = "absolute";
        this.element1.style.backgroundColor = "rgb(147, 225, 38)";
        this.element1.style.width = width + "%";
        this.element1.style.height = height + "%";
        this.element1.style.margin = "8px";
        this.element1.style.right = "20px";
        this.element1.style.top = "50px"
        this.element1.style.borderRadius = "10px";

        this.light_option = false;
        this.beMove = false;

        this.continer.appendChild(this.element1);
        //this.addsection_light(this.element1);
        this.addDraggable(this.element1);

    }

    //被点击属性 左键 附着元素
    //测试版本 预计淘汰
    // program_show(){
    //     this.program.style.display = "block"

    //     setTimeout(() => {
    //         this.program.style.opacity = "100%";
    //         this.program.style.left = "120px";
    //     }, 100);

    // }

    // program_diapper(){
    //     this.program.style.left = "60px";
    //     this.program.style.opacity = "0%";

    // }
    // addsection_light(element){
    //     element.addEventListener("mousemove",() =>{
    //         this.beMove = true;
    //     });
    //     element.addEventListener("mouseup",(event) =>{
    //         if(event.button == 0){
    //             if(this.beMove == false){
    //                 if(this.light_option){
    //                     //消失
    //                     this.program_diapper();
    //                     this.light_option = false;
    //                 }else{
    //                     //弹出
    //                     this.program_show();
    //                     this.light_option = true;
    //                 }   
    //             }
    //             this.beMove = false;
    //         }
    //     });
    // }

    //增加拖动函数
    addDraggable(element){
        element.addEventListener("mousedown",(event) =>{
            if(event.button == 0){
                this.beMove = false;
                // 确保按下时没有动画
                element.style.transition = "0ms"//在任务条拖动时，如果拥有延时属性，所以不要乱动保持在一开始拖动时，保持着0ms的延时

                //获取位移信息
                let shiftX = event.clientX - element.getBoundingClientRect().left;
                let shiftY = event.clientY - element.getBoundingClientRect().top;

                //设立回调函数
                const moveAt = function(pageX,pageY){

                    let newLeft = pageX - shiftX;
                    let newTop = pageY - shiftY;
                    
                    const continer_tmp = borad.getBoundingClientRect();

                    const element_tmp = element.getBoundingClientRect();
                    const element_W = element_tmp.width;
                    const element_H = element_tmp.height;
                    
                    //设立边界
                    if(newLeft < 0) newLeft = 0;
                    if(newTop < 0) newTop = 0;
                    if(newLeft + element_W > continer_tmp.width) newLeft = continer_tmp.width - element_W;
                    if(newTop + element_H > continer_tmp.height) newTop = continer_tmp.height - element_H; 
        

                    element.style.left = newLeft - 10 + 'px';
                    element.style.top = newTop - 10 + 'px';
                }
                const onMouseMove = (e) =>{
                    this.beMove = true;
                    moveAt(e.pageX,e.pageY);
                }

                //鼠标移动回调
                setTimeout(() => {
                    document.addEventListener("mousemove",onMouseMove);
                }, 20);

                //鼠标松开回调
                document.addEventListener("mouseup",(e) =>{

                    //开启延迟属性
                    element.style.transition = '300ms';

                    //用于附着的成员变量
                    var doubleEle = element.getBoundingClientRect().left - borad.getBoundingClientRect().left;
                    var board_width = borad.offsetWidth / 10;

                    //开始判断附着在哪一部分
                    if(doubleEle < board_width / 2){
                        element.style.left = 0 + '%';
                    }else{
                        //0 10 20 30 40 50 60 70 80 90
                        var tmp = Math.floor(doubleEle / board_width);
                        var long_loc =  (Math.floor(doubleEle / board_width)) * board_width
                        if(doubleEle - long_loc > board_width / 2){
                            element.style.left = (tmp + 1) * 10  + '%';
                        }else{  
                            element.style.left = tmp * 10  + '%';   
                        }   
                    }   

                    //取消回调  
                    document.removeEventListener('mousemove',onMouseMove);   

                },{once: true});
            }
        });
    }
}

new DraggableContainer("show_window");


//任务详情展示hover aphla
program_sample.addEventListener("mousemove",function(e){

    detail.style.opacity = "0%";
    detail.style.transition = "300ms";
    detail.style.display = "block";
    detail.style.opacity = "80%";
})

function moveoutFunc(event){
    if (event.relatedTarget != detail && event.relatedTarget != program_sample){
        detail.style.opacity = "0%"
        setTimeout(function(){
            detail.style.display = "none";
        }, 300)
    }
}
detail.addEventListener("mouseout",moveoutFunc);
program_sample.addEventListener("mouseout",moveoutFunc);


//create函数
buttonCreate.addEventListener("click",function(e){
    new DraggableContainer("show_window");

    // 创建新的div元素

    // let newElement = document.createElement('div');

    // // 设置元素的属性和样式
    // newElement.id = 'program';
    // newElement.style.transition = '300ms';
    // newElement.style.position = 'absolute';
    // newElement.style.backgroundColor = 'rgb(147, 225, 38)';
    // newElement.style.width = '9%';
    // newElement.style.height = '8%';
    // newElement.style.margin = '8px';
    // newElement.style.borderRadius = '10px';

    // 将新元素添加到指定的父元素中
})

//设立封装监听函数
function addDraggable(element){
    element.addEventListener("mousedown",function(event){
        
        //直接产生新的任务条
        buttonCreate.click();

        // 确保按下时没有动画
        element.style.transition = "0ms"//在任务条拖动时，如果拥有延时属性，所以不要乱动保持在一开始拖动时，保持着0ms的延时

        //获取位移信息
        let shiftX = event.clientX - element.getBoundingClientRect().left;
        let shiftY = event.clientY - element.getBoundingClientRect().top;

        //设立回调函数
        const moveAt = function(pageX,pageY){
            element.style.left = pageX - shiftX - 10 + 'px';
            element.style.top = pageY - shiftY - 10 + 'px';
        }
        const onMouseMove = function(e){
            moveAt(e.pageX,e.pageY);
        }

        //鼠标移动回调
        document.addEventListener("mousemove",onMouseMove);

        //鼠标松开回调
        document.addEventListener("mouseup",function(e){
            
            //开启延迟属性
            element.style.transition = '300ms';

            //用于附着的成员变量
            var doubleEle = element.getBoundingClientRect().left - borad.getBoundingClientRect().left;
            var board_width = borad.offsetWidth / 10;

            //开始判断附着在哪一部分
            if(doubleEle < board_width / 2){
                element.style.left = 0 + '%';
            }else{
                //0 10 20 30 40 50 60 70 80 90
                var tmp = Math.floor(doubleEle / board_width);
                var long_loc =  (Math.floor(doubleEle / board_width)) * board_width
                if(doubleEle - long_loc > board_width / 2){
                    element.style.left = (tmp + 1) * 10  + '%';
                }else{
                    element.style.left = tmp * 10  + '%';
                }
            }

            //取消回调
            document.removeEventListener('mousemove',onMouseMove);   
        },{once: true});
    });
}


</script>
</html>